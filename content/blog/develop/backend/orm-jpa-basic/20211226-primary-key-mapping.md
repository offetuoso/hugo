---
title: "[자바 ORM 표준 JPA] 기본키 매핑"
image: "bg-jpa.png"
font_color: "white"
font_size: "28px"
opacity: "0.4"
date: 2021-12-26
slug: "primary-key-mapping"
description: "기본키 매핑"	
keywords: ["ORM"]
draft: true
categories: ["Java"]
subcategories: ["JPA"]
tags: ["Java","JPA","ORM", "인프런", "김영한", "자바 ORM 표준 JPA"]
math: false
toc: true
---


# 기본키 매핑
## 기본 키 매핑 어노테이션
> - @Id
> - @GeneratedValue

```
@Id @GeneratedValue(strategy = GenerationTpye.AUTO)
private Long id;
```

## 기본 키 매핑 방법
> - 직접 할당 : @Id 만 사용
> - 자동 생성(@GeneratedValue)
>	- IDENTITY : 데이터베이스에 위임, MySLQ)
>	- SEQUENCE : 데이터베이스 시퀀스 오브젝트 사용, ORACLE 
>		- @SequenceGenerator 필요
> - TABLE: 키 생성용 테이블 사용, 모든 DB에서 사용
> 	- @TableGenerator 필요
> - AUTO: 방언에 따라 자동 지정, 기본값

### 기본 키 매핑 방법 테스트

#### Id 직접할당 - @Id 사용

> Member.java
> 기본 키 매핑에 좀더 집중하기 위해 Memeber의 Id를 String 으로 변경하고, Id, name을 제외한 나머지를 일단 제거합니다.

```
   package hellojpa;

import javax.persistence.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;

@Entity
public class Member {

    @Id
    private String id;

    @Column(name="name", length = 10) 
    private String userName;


    public Member() {
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }
}

```

> JpaMain.java

```
            Member member1 = new Member();
            member1.setId("ID_A");
            member1.setUserName("유저A");
            em.persist(member1);

            tx.commit();
```

![contact](/images/develop/backend/orm-jpa-basic/primary-key-mapping/img-001.png)

![contact](/images/develop/backend/orm-jpa-basic/primary-key-mapping/img-002.png)

#### Id 자동할당 - @GeneratedValue
> GeneratedValue의 전략은 AUTO, IDENTITY, SEQUENCE, TABLE가 있으며, <br>
AUTO는 방언에 따라 다르게 생성


```
    @GeneratedValue(strategy = GenerationType.AUTO) 
    @GeneratedValue(strategy = GenerationType.IDENTITY) 위임함
    @eneratedValue(strategy = GenerationType.SEQUENCE) 
    @GeneratedValue(strategy = GenerationType.TABLE) 
    
```

##### GenerationType.IDENTITY - 특징
> - 기본 키 생성을 데이터베이스에 위임
> - 주로 MySQL, PostgreSQL, SQL Server. DB2에서 사용<BR>
	예) MySQL의 AUTO_INCREMENT
> - JPA는 보통 트랜잭션 커밋 시점에 INSERT SQL 실행
> - AUTO_INCREMENMT는 데이터베이스에 INSERT SQL을 실헹한 이후에 ID 값을 알 수 있음
> - IDENTITY 전략은 em.persist() 시점에 즉시 INSERT_SQL 실행하고 DB에서 식별자를 조회

````
    @Id
    @GeneratedValue(strategy  = GenerationType.IDENTITY) 
    private String id;
    
````

>  강의를 따라하던중 아래와 같은 에러가 발생하였고, 자동 생성되는 키 값들은 대부분 숫자로 되어있기 때문에 Id를 다시 Integer로 변경하였더니 해결되었습니다. 

```
Hibernate: 
    
    drop table Member if exists
Hibernate: 
    
    create table Member (
       id varchar(255) generated by default as identity,
        name varchar(10),
        primary key (id)
    )
12월 26, 2021 10:48:37 오후 org.hibernate.resource.transaction.backend.jdbc.internal.DdlTransactionIsolatorNonJtaImpl getIsolatedConnection
INFO: HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@2a2da905] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
12월 26, 2021 10:48:37 오후 org.hibernate.resource.transaction.backend.jdbc.internal.DdlTransactionIsolatorNonJtaImpl getIsolatedConnection
INFO: HHH10001501: Connection obtained from JdbcConnectionAccess [org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator$ConnectionProviderJdbcConnectionAccess@1b11ef33] for (non-JTA) DDL execution was not in auto-commit mode; the Connection 'local transaction' will be committed and the Connection will be set into auto-commit mode.
12월 26, 2021 10:48:37 오후 org.hibernate.tool.schema.internal.ExceptionHandlerLoggedImpl handleException
WARN: GenerationTarget encountered exception accepting command : Error executing DDL "
    create table Member (
       id varchar(255) generated by default as identity,
        name varchar(10),
        primary key (id)
    )" via JDBC Statement
org.hibernate.tool.schema.spi.CommandAcceptanceException: Error executing DDL "
    create table Member (
       id varchar(255) generated by default as identity,
        name varchar(10),
        primary key (id)
    )" via JDBC Statement
	at org.hibernate.tool.schema.internal.exec.GenerationTargetToDatabase.accept(GenerationTargetToDatabase.java:67)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.applySqlString(SchemaCreatorImpl.java:440)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.applySqlStrings(SchemaCreatorImpl.java:424)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.createFromMetadata(SchemaCreatorImpl.java:315)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.performCreation(SchemaCreatorImpl.java:166)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.doCreation(SchemaCreatorImpl.java:135)
	at org.hibernate.tool.schema.internal.SchemaCreatorImpl.doCreation(SchemaCreatorImpl.java:121)
	at org.hibernate.tool.schema.spi.SchemaManagementToolCoordinator.performDatabaseAction(SchemaManagementToolCoordinator.java:155)
	at org.hibernate.tool.schema.spi.SchemaManagementToolCoordinator.process(SchemaManagementToolCoordinator.java:72)
	at org.hibernate.internal.SessionFactoryImpl.<init>(SessionFactoryImpl.java:310)
	at org.hibernate.boot.internal.SessionFactoryBuilderImpl.build(SessionFactoryBuilderImpl.java:467)
	at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:939)
	at org.hibernate.jpa.HibernatePersistenceProvider.createEntityManagerFactory(HibernatePersistenceProvider.java:56)
	at javax.persistence.Persistence.createEntityManagerFactory(Persistence.java:79)
	at javax.persistence.Persistence.createEntityManagerFactory(Persistence.java:54)
	at hellojpa.JpaMain.main(JpaMain.java:12)
Caused by: org.h2.jdbc.JdbcSQLFeatureNotSupportedException: Feature not supported: "CHARACTER VARYING(255)"; SQL statement:

    create table Member (
       id varchar(255) generated by default as identity,
        name varchar(10),
        primary key (id)
    ) [50100-202]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:556)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:477)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.message.DbException.getUnsupportedException(DbException.java:287)
	at org.h2.command.ddl.SequenceOptions.getBounds(SequenceOptions.java:313)
	at org.h2.command.ddl.SequenceOptions.getBounds(SequenceOptions.java:244)
	at org.h2.schema.Sequence.<init>(Sequence.java:101)
	at org.h2.table.Column.initializeSequence(Column.java:459)
	at org.h2.command.ddl.CommandWithColumns.generateSequences(CommandWithColumns.java:103)
	at org.h2.command.ddl.CreateTable.update(CreateTable.java:110)
	at org.h2.command.CommandContainer.update(CommandContainer.java:173)
	at org.h2.command.Command.executeUpdate(Command.java:247)
	at org.h2.server.TcpServerThread.process(TcpServerThread.java:413)
	at org.h2.server.TcpServerThread.run(TcpServerThread.java:190)
	at java.base/java.lang.Thread.run(Thread.java:834)

	at org.h2.message.DbException.getJdbcSQLException(DbException.java:507)
	at org.h2.engine.SessionRemote.done(SessionRemote.java:611)
	at org.h2.command.CommandRemote.executeUpdate(CommandRemote.java:237)
	at org.h2.jdbc.JdbcStatement.executeInternal(JdbcStatement.java:228)
	at org.h2.jdbc.JdbcStatement.execute(JdbcStatement.java:201)
	at org.hibernate.tool.schema.internal.exec.GenerationTargetToDatabase.accept(GenerationTargetToDatabase.java:54)
	... 15 more

12월 26, 2021 10:48:37 오후 org.hibernate.tool.schema.internal.SchemaCreatorImpl applyImportSources
INFO: HHH000476: Executing import script 'org.hibernate.tool.schema.internal.exec.ScriptSourceInputNonExistentImpl@1eba372c'
```

> Member.java

```
    @Id
    @GeneratedValue(strategy  = GenerationType.IDENTITY) // 방언에 따라 다르게 생성
    private Integer id; 
```

![contact](/images/develop/backend/orm-jpa-basic/primary-key-mapping/img-002.png)

> persistence.xml에서 MySQL 방언으로 다시 실행

![contact](/images/develop/backend/orm-jpa-basic/primary-key-mapping/img-003.png)

> AUTO_INCREMENT로 키를 생성하겠다 설정이 된것을 볼 수 있습니다.


> H2 1.4.202 버전을 사용하고 있는데, @GeneratedValue(strategy  = GenerationType.IDENTITY) 가 적용이 안되고, <br>
ERROR: NULL not allowed for column "ID"; SQL statement:
/* insert hellojpa.Member */ insert into Member (id, name) values (null, ?) [23502-200] <br>
오류가 발생하여 검색을 해보니 최신 H2 DB에 버그라고 하네요. 

<a href="https://docs.google.com/document/d/1j0jcJ9EoXMGzwAA2H0b9TOvRtpwlxI5Dtn3sRtuXQas/edit#">
h2 데이터베이스는 꼭 다음 링크에 들어가서 1.4.200 버전을 설치해주세요.
최근에 나온 2.0.202 버전을 설치하면 일부 기능이 정상 동작하지 않습니다
</a>

> 2.0.200 버전으로 다시 설치 하였습니다. 

이미지 다시 떠야함 ㅠㅠㅠ



```
Hibernate: 
    /* insert hellojpa.Member
        */ insert 
        into
            Member
            (id, name) 
        values
            (null, ?)
12월 26, 2021 11:09:52 오후 org.hibernate.engine.jdbc.spi.SqlExceptionHelper logExceptions
WARN: SQL Error: 23502, SQLState: 23502
12월 26, 2021 11:09:52 오후 org.hibernate.engine.jdbc.spi.SqlExceptionHelper logExceptions
ERROR: NULL not allowed for column "ID"; SQL statement:
/* insert hellojpa.Member */ insert into Member (id, name) values (null, ?) [23502-200]
12월 26, 2021 11:09:52 오후 org.hibernate.engine.jdbc.connections.internal.DriverManagerConnectionProviderImpl stop
INFO: HHH10001008: Cleaning up connection pool [jdbc:h2:tcp://localhost/~/test]

Process finished with exit code 0

```



## 참고- <a href="https://www.inflearn.com/course/ORM-JPA-Basic">자바 ORM 표준 JPA - 김영한</a>
